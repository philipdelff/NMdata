<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1" />



<title>Data creation tools</title>

<script>// Pandoc 2.9 adds attributes on both header and div. We remove the former (to
// be compatible with the behavior of Pandoc < 2.8).
document.addEventListener('DOMContentLoaded', function(e) {
  var hs = document.querySelectorAll("div.section[class*='level'] > :first-child");
  var i, h, a;
  for (i = 0; i < hs.length; i++) {
    h = hs[i];
    if (!/^h[1-6]$/i.test(h.tagName)) continue;  // it should be a header h1-h6
    a = h.attributes;
    while (a.length > 0) h.removeAttribute(a[0].name);
  }
});
</script>


<style type="text/css">code{white-space: pre;}</style>
<style type="text/css" data-origin="pandoc">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */

</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    for (var j = 0; j < rules.length; j++) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") continue;
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') continue;
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>



<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; } 
code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>




</head>

<body>




<h1 class="title toc-ignore">Data creation tools</h1>



<p>Built 2021-04-05 using NMdata 0.0.6.7.902.</p>
<div id="introduction" class="section level2">
<h2>Introduction</h2>
<p>Nonmem has quite a number of restrictions on the format of the input data, and problems with the data set is a very common reason for Nonmem not to behave as expected. When this happens, you easily waste a lot time debugging the data. <code>NMdata</code> includes some simple functions to prevent these situations.</p>
<p>This vignette uses <code>data.table</code> syntax for the little bit of data manipulation performed. However, you don’t need to use data.table <em>at all</em> to use these tools or any tool in <code>NMdata</code>. The reason why the functions return data.table objects is that the data set is a <code>data.table</code> to begin with</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true"></a>pk &lt;-<span class="st"> </span><span class="kw">readRDS</span>(<span class="dt">file =</span> <span class="kw">system.file</span>(<span class="st">&quot;examples/data/xgxr2.rds&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;NMdata&quot;</span>))</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true"></a><span class="kw">class</span>(pk)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true"></a><span class="co">#&gt; [1] &quot;data.table&quot; &quot;data.frame&quot;</span></span></code></pre></div>
<p>If this was a <code>data.frame</code>, the <code>NMdata</code> functions would keep returning objects of class <code>data.frame</code>.</p>
</div>
<div id="automated-checks-of-merge-results" class="section level2">
<h2>Automated checks of merge results</h2>
<p>Merges are a very common source of data creation bugs. As simple as they may seem, merges likely leave you with an unexpected number of rows, some repeated or some omitted. Merges are very powerful and flexible, and when preparing a data set, they are fundamental. However, many merges for dataset creation are of the specific and simple kind where columns are added to an existing dataset. In this situation the rows that come out of the merge are the exact same as in one of the existing datasets. Say we want to add a covariate from a <code>dt.cov</code>. Imagine we just assume that all subjects are represented with one row each in <code>dt.cov</code>, and so we expect the number of rows to be unchanged from <code>pk</code>:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true"></a><span class="kw">dim</span>(pk)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true"></a><span class="co">#&gt; [1] 1502   24</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true"></a><span class="co">## the number of unique values of ID in pk</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true"></a>pk[, <span class="kw">uniqueN</span>(ID)]</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true"></a><span class="co">#&gt; [1] 150</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true"></a>pk[, <span class="kw">range</span>(ID)]</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true"></a><span class="co">#&gt; [1]  31 180</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true"></a><span class="co">## dt.cov has a covariate for some of the subjects</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true"></a>dt.cov</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true"></a><span class="co">#&gt;     ID COV</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true"></a><span class="co">#&gt;  1: 31   2</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true"></a><span class="co">#&gt;  2: 32   3</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true"></a><span class="co">#&gt;  3: 33   3</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true"></a><span class="co">#&gt;  4: 34   4</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true"></a><span class="co">#&gt;  5: 35   2</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true"></a><span class="co">#&gt;  6: 36   5</span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true"></a><span class="co">#&gt;  7: 37   2</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true"></a><span class="co">#&gt;  8: 38   2</span></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true"></a><span class="co">#&gt;  9: 39   3</span></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true"></a><span class="co">#&gt; 10: 40   2</span></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true"></a>pk2 &lt;-<span class="st"> </span><span class="kw">merge</span>(pk, dt.cov, <span class="dt">by =</span> <span class="st">&quot;ID&quot;</span>)</span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true"></a><span class="kw">dim</span>(pk2)</span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true"></a><span class="co">#&gt; [1] 100  25</span></span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true"></a><span class="co">## now as expected</span></span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true"></a>pk3 &lt;-<span class="st"> </span><span class="kw">merge</span>(pk, dt.cov, <span class="dt">by =</span> <span class="st">&quot;ID&quot;</span>, <span class="dt">all.x =</span> <span class="ot">TRUE</span>)</span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true"></a><span class="kw">dim</span>(pk3)</span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true"></a><span class="co">#&gt; [1] 1502   25</span></span></code></pre></div>
<p>So when creating <code>pk2</code> we lost a lot of rows because we forgot the <code>all.x</code> option. And also as we shall now see, just checking the resulting dimensions is not enough.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true"></a>dt.cov2</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true"></a><span class="co">#&gt;       ID COV</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true"></a><span class="co">#&gt;   1:  31   4</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true"></a><span class="co">#&gt;   2:  31   4</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true"></a><span class="co">#&gt;   3:  32   4</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true"></a><span class="co">#&gt;   4:  33   1</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true"></a><span class="co">#&gt;   5:  34   2</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true"></a><span class="co">#&gt;  ---        </span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true"></a><span class="co">#&gt; 146: 175   4</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true"></a><span class="co">#&gt; 147: 176   4</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true"></a><span class="co">#&gt; 148: 177   5</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true"></a><span class="co">#&gt; 149: 178   3</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true"></a><span class="co">#&gt; 150: 179   4</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true"></a>pk4 &lt;-<span class="st"> </span><span class="kw">merge</span>(pk, dt.cov2, <span class="dt">by =</span> <span class="st">&quot;ID&quot;</span>)</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true"></a><span class="kw">dim</span>(pk4)</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true"></a><span class="co">#&gt; [1] 1502   25</span></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true"></a><span class="co">## we now have twice as many rows for this subject</span></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true"></a>pk[ID <span class="op">==</span><span class="st"> </span><span class="dv">31</span>, .N]</span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true"></a><span class="co">#&gt; [1] 10</span></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true"></a>pk4[ID <span class="op">==</span><span class="st"> </span><span class="dv">31</span>, .N]</span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true"></a><span class="co">#&gt; [1] 20</span></span></code></pre></div>
<p>As illustrated by these simple examples, even the simplest merges have to be rigorously checked, no exceptions. The function <code>mergeCheck(x1,x2)</code> ensures that the result has exactly one of each rows from <code>x1</code> and nothing else. We can use <code>...</code> to pass additional arguments to merge.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true"></a>pk2 &lt;-<span class="st"> </span><span class="kw">try</span>(<span class="kw">mergeCheck</span>(pk, dt.cov, <span class="dt">by =</span> <span class="st">&quot;ID&quot;</span>))</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true"></a><span class="co">#&gt; Warning in mergeCheck(pk, dt.cov, by = &quot;ID&quot;): Rows disappeared during merge.</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true"></a><span class="co">#&gt; Warning in mergeCheck(pk, dt.cov, by = &quot;ID&quot;): </span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true"></a><span class="co">#&gt; nrow(pk): 1502</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true"></a><span class="co">#&gt; nrow(dt.cov): 10</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true"></a><span class="co">#&gt; nrow(merged.df): 100</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true"></a><span class="co">#&gt; Error in mergeCheck(pk, dt.cov, by = &quot;ID&quot;) : </span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true"></a><span class="co">#&gt;   Merge added and/or removed rows.</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true"></a><span class="co">## now as expected</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true"></a>pk3 &lt;-<span class="st"> </span><span class="kw">mergeCheck</span>(pk, dt.cov, <span class="dt">by =</span> <span class="st">&quot;ID&quot;</span>, <span class="dt">all.x =</span> <span class="ot">TRUE</span>)</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true"></a><span class="kw">dim</span>(pk3)</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true"></a><span class="co">#&gt; [1] 1502   25</span></span></code></pre></div>
<p>The result always has the same row order as the <code>x1</code> argument.</p>
<p>Another problem that the programmer may not realize during a merge is that column names are shared across <code>x1</code> and <code>x2</code> (in addition to columns that are being merged by). This will silently create colmn names like <code>col.x</code> and <code>col.y</code> in the output. <code>mergeCheck</code> will by default give a warning if that happens.</p>
<p>There is only one difference from the behaviour of the <code>merge.data.frame</code> function syntax, being that the <code>by</code> argument must always be supplied to <code>mergeCheck</code>.</p>
<p>You may think that this will limit your merges, and that you need merges for inner and outer joins etc. You are exactly right - <code>mergeCheck</code> is not intended for those merges and does not support them. When that is said, the kind of merges that are supported, are indeed very common. To illustrate how common, all merges in the <code>NMdata</code> package are performed with <code>mergeCheck</code>.</p>
</div>
<div id="exclusion-flags" class="section level2">
<h2>Exclusion flags</h2>
<p>It is good practice not to discard records from a dataset but to flag them and omit them in model estimation. When reporting the analysis, we also need to account for how many data records were discarded due to which criteria. A couple of functons in <code>NMdata</code> help you do this in a way that is easy to integrate with Nonmem.</p>
<p>The implementation in <code>NMdata</code> is based on sequentially checking exclusion conditions. This means we can summarize how many records and subjects were excluded from the analysis due to the different criteria. The information is represented in one numerical column for Nonmem, and one (equivalent) column for the rest of us in the resulting data.</p>
<p>It is good practice to keep all information needed to evaluate the exclusion criteria in the data. Say we exclude observations if they are flagged for reanalysis by bioanalysis. If we first run a criteria for time to be non-negative, we would no longer know which of the observations with negative time that were flagged for reanalysis based on the exclusion flag.</p>
<div id="assign-and-count-flags" class="section level3">
<h3>Assign and count flags</h3>
<p>For use in Nonmem, the easiest is that inclusion/exclusion is determined by a single column in data - we call that column <code>FLAG</code> here, but any column name can be used. <code>FLAG</code> obviously draws on information from other columns such as <code>TIME</code>, <code>DV</code>, and many others, depending on your dataset and your way of working.</p>
<p>The function that applies inclusion/excluasion rules is called <code>flagsAssign</code>, and it takes a dataset and a data.frame with rules as arguments.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true"></a>pk &lt;-<span class="st"> </span><span class="kw">readRDS</span>(<span class="dt">file =</span> <span class="kw">system.file</span>(<span class="st">&quot;examples/data/xgxr2.rds&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;NMdata&quot;</span>))</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true"></a>dt.flags &lt;-<span class="st"> </span><span class="kw">fread</span>(<span class="dt">text =</span> <span class="st">&quot;FLAG,flag,condition</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true"></a><span class="st">100,Negative time,EVID==0&amp;TIME&lt;0</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true"></a><span class="st">10,Below LLOQ,EVID==0&amp;BLQ==1&quot;</span>)</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true"></a></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true"></a>pk &lt;-<span class="st"> </span><span class="kw">flagsAssign</span>(pk, <span class="dt">tab.flags =</span> dt.flags)</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true"></a><span class="co">#&gt; In flagsAssign(pk, tab.flags = dt.flags) : Data contains FLAG already. This is</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true"></a><span class="co">#&gt; overwritten</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true"></a><span class="co">#&gt; In flagsAssign(pk, tab.flags = dt.flags) : Data contains flag already. This is</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true"></a><span class="co">#&gt; overwritten</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true"></a><span class="co">#&gt; Coding FLAG = 100, flag = Negative time</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true"></a><span class="co">#&gt; Coding FLAG = 10, flag = Below LLOQ</span></span></code></pre></div>
<p>Your first question may be why <code>fread</code> is used to create a data.table (like <code>read.csv</code> to create a data.frame). The reason is that this way, we can write the information line by line. If you have ten lines in the dataset above and do <code>data.frame(FLAG=...,flag=...,condition=...)</code> it gets impossible to read what elements of the three columns that correspond.</p>
<p><code>flagsAssign</code> applies the conditions sequentially and by increasing value of <code>FLAG</code>. <code>FLAG=0</code> means that the observation is included in the analysis. You can use any expression that can be evaluated within the data.frame. In this case, <code>BLQ</code> has to exist in <code>pk</code>.</p>
<p>Actually, the evaluated expressions are slightly different from what is written in the table above. <code>flagsAssign</code> will prepend the condition that <code>FLAG==0</code> in order for the conditions to be sequential. Again, the omission will be attributed to the first condition matched.</p>
<p>What rows to omit from a dataset can vary from one analysis to another. Hence, the aim with the chosen design is that the inclusion criteria can be changed and applied to overwrite an existing inclusion/exclusion selection. For another analysis we want to include the observations below LLOQ, so we create a different exclusion flag for that one:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true"></a>dt.flags2 &lt;-<span class="st"> </span><span class="kw">fread</span>(<span class="dt">text =</span> <span class="st">&quot;FLAG2,flag2,condition</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true"></a><span class="st">10,Negative time,TIME&lt;0&quot;</span>)</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true"></a></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true"></a>pk &lt;-<span class="st"> </span><span class="kw">flagsAssign</span>(pk, dt.flags2, <span class="dt">col.flagn =</span> <span class="st">&quot;FLAG2&quot;</span>, <span class="dt">col.flagc =</span> <span class="st">&quot;flag2&quot;</span>)</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true"></a><span class="co">#&gt; Coding FLAG2 = 10, flag2 = Negative time</span></span></code></pre></div>
</div>
<div id="summarize-data-exclusions" class="section level3">
<h3>Summarize data exclusions</h3>
<p>An overview of the number of observations disregarded due to the different conditions is then obtained using <code>flagsCount</code>:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true"></a>tab.count &lt;-<span class="st"> </span><span class="kw">flagsCount</span>(<span class="dt">data =</span> pk[EVID <span class="op">==</span><span class="st"> </span><span class="dv">0</span>], <span class="dt">tab.flags =</span> dt.flags)</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true"></a><span class="kw">print</span>(tab.count)</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true"></a><span class="co">#&gt;                  flag N.left Nobs.left N.discarded Nobs.discarded</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true"></a><span class="co">#&gt; 1: All available data    150      1352          NA             NA</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true"></a><span class="co">#&gt; 2:      Negative time      0         0         150           1352</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true"></a><span class="co">#&gt; 3:         Below LLOQ      0         0           0              0</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true"></a><span class="co">#&gt; 4:       Analysis set      0         0          NA             NA</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true"></a>tab.count2 &lt;-<span class="st"> </span><span class="kw">flagsCount</span>(<span class="dt">data =</span> pk[EVID <span class="op">==</span><span class="st"> </span><span class="dv">0</span>], <span class="dt">tab.flags =</span> dt.flags2, </span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true"></a>    <span class="dt">col.flagn =</span> <span class="st">&quot;FLAG2&quot;</span>, <span class="dt">col.flagc =</span> <span class="st">&quot;flag2&quot;</span>)</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true"></a><span class="kw">print</span>(tab.count2)</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true"></a><span class="co">#&gt;                 flag2 N.left Nobs.left N.discarded Nobs.discarded</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true"></a><span class="co">#&gt; 1: All available data    150      1352          NA             NA</span></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true"></a><span class="co">#&gt; 2:      Negative time      0         0         150           1352</span></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true"></a><span class="co">#&gt; 3:       Analysis set      0         0          NA             NA</span></span></code></pre></div>
<p><code>flagsCount</code> includes a <code>file</code> option to save the the table right away.</p>
</div>
</div>
<div id="finalize-data-format-and-write-to-file" class="section level2">
<h2>Finalize data format and write to file</h2>
<p>Once you have your dataset in place, <code>NMdata</code> provides a few useful functions. At this point, ideally you check your data for any inconsistency. If you miss an inconsistency, you need to wait for Nonmem to finish if the inconsistency is not fatal for Nonmem’s ability to run the model. Then, you may still not realize and continue working with Nonmem to build the model before you realize that something is wrong. <code>NMdata</code> is still ways from providing a sufficient set of tests to run, but still these checks are useful and easy and cheap to run.</p>
<div id="automated-ordering-of-columns" class="section level3">
<h3>Automated ordering of columns</h3>
<p>The order of columns in Nonmem is important for two reasons. One is that a character in a variable read into Nonmem will make the run fail. The other is that there are restrictions on the number of variables you can read into Nonmem, depending on the version. <code>NMcolOrders</code> tries to put the used columns first, and other or maybe even unusable columns in the back of the dataset. It does so by a mix of recognition or column names and analysis of the column contents.</p>
<p>Columns that cannot be converted to numeric are put in the back, while column bearing standard Nonmem variable names like <code>ID</code>, <code>TIME</code>, <code>EVID</code> etc. will be pulled up front. You can of course add column names to prioritize to front (<code>first</code>) or back (<code>last</code>). See <code>?NMorderColumns</code> for more options.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true"></a>pk &lt;-<span class="st"> </span><span class="kw">NMorderColumns</span>(pk)</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true"></a><span class="co">#&gt; Warning: In NMorderColumns(pk) : These standard nonmem columns were not found in data:</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true"></a><span class="co">#&gt; nomtime II ADDL SS MDV</span></span></code></pre></div>
</div>
<div id="writing-data-to-files" class="section level3">
<h3>Writing data to files</h3>
<p>For the final step of writing the dataset, <code>NMwriteData</code> is provided. Most importantly, it writes a csv for Nonmem and an rds for R with equal contents, but with the rds including all information (such as factor levels) which cannot be saved in csv (NMscanData will know how to make use of this information once you retrieve the Nonmem results). It also provides a proposal for text to include in the <code>$INPUT</code> and <code>$DATA</code> sections of the Nonmem control streams - for you to copy-paste.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true"></a><span class="kw">NMwriteData</span>(pk)</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true"></a><span class="co">#&gt; Nonmem data file:</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true"></a><span class="co">#&gt; </span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true"></a><span class="co">#&gt; For NonMem:</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true"></a><span class="co">#&gt; $INPUT ROW ID TIME EVID CMT AMT DV FLAG STUDY BLQ CYCLE DOSE FLAG2</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true"></a><span class="co">#&gt; NOMTIME PART PROFDAY PROFTIME WEIGHTB eff0</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true"></a><span class="co">#&gt; $DATA </span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true"></a><span class="co">#&gt; IGN=@</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true"></a><span class="co">#&gt; IGNORE=(FLAG.NE.0)</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true"></a><span class="co">#&gt; </span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true"></a><span class="co">#&gt; Data returned but not written to file(s).</span></span></code></pre></div>
<p>If a file name had been provided, the data would have been written, and the path to the data file would have been included in the message written back to the user. There are several arguments that will affect the proposed text for the Nonmem run, see <code>?NMwriteData</code>.</p>
</div>
</div>
<div id="stamp-objects-for-traceability" class="section level2">
<h2>Stamp objects for traceability</h2>
<p>The last couple of functions that will be introduced here are used for tracing datasets to data creation scripts, including time stamps and other information you want to include with the data set.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true"></a>pk &lt;-<span class="st"> </span><span class="kw">stampObj</span>(pk, <span class="dt">script =</span> <span class="st">&quot;vignettes/DataCreate.Rmd&quot;</span>)</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true"></a><span class="kw">objInfo</span>(pk)</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true"></a><span class="co">#&gt; $DataCreateScript</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true"></a><span class="co">#&gt; [1] &quot;vignettes/DataCreate.Rmd&quot;</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true"></a><span class="co">#&gt; </span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true"></a><span class="co">#&gt; $CreationTime</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true"></a><span class="co">#&gt; [1] &quot;2021-04-05 17:19:56 EDT&quot;</span></span></code></pre></div>
<p>The <code>script</code> argument is recognized by <code>stampObj</code>, but you can add anything to this. Say you want to keep descriptive note too:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true"></a>pk &lt;-<span class="st"> </span><span class="kw">stampObj</span>(pk, <span class="dt">script =</span> <span class="st">&quot;vignettes/DataCreate.Rmd&quot;</span>, <span class="dt">Description =</span> <span class="st">&quot;A PK dataset used for examples.&quot;</span>)</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true"></a><span class="kw">objInfo</span>(pk)</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true"></a><span class="co">#&gt; $DataCreateScript</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true"></a><span class="co">#&gt; [1] &quot;vignettes/DataCreate.Rmd&quot;</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true"></a><span class="co">#&gt; </span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true"></a><span class="co">#&gt; $CreationTime</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true"></a><span class="co">#&gt; [1] &quot;2021-04-05 17:19:56 EDT&quot;</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true"></a><span class="co">#&gt; </span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true"></a><span class="co">#&gt; $Description</span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true"></a><span class="co">#&gt; [1] &quot;A PK dataset used for examples.&quot;</span></span></code></pre></div>
<p>These are very simple functions. But they are simple to use as well, and hopefully they will help you avoid sitting with a data set trying to guess which script generated it so you can do a modification or understand how something was done.</p>
<p>When using <code>NMwriteData</code>, you don’t have to call <code>stampObj</code> explicitly. Just pass the <code>script</code> argument to <code>NMwriteData</code> and <code>stampObj</code> will be applied automatically.</p>
</div>
<div id="subject-level-variables" class="section level2">
<h2>Subject-level variables</h2>
<p>In a proper PK/PD analysis we need to explore the data at multiple variability levels. What we looked at above is at dosing and sampling level (one row per dosing or sampling event). <code>NMdata</code> provides very useful functions to extract information at other levels of variability. Before extracting the subject-level information we will add an individual exposure measure to the dataset. We will use the empirical Bayes’ estimate of the individual maximum concentration. This is derived as the maximum prediction across the sample times - it may be better to simulate the model at a richer time scale to get better precision. Again, we make use of <code>data.table</code> but feel free to use what you prefer. <code>findCovs</code> - like other <code>NMdata</code> functions - will work on <code>data.frame</code>’s, <code>tibble</code>’s and other <code>data.frame</code>-like classes (classes that inherit from <code>data.frame</code>).</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true"></a>res1 &lt;-<span class="st"> </span><span class="kw">NMscanData</span>(<span class="kw">system.file</span>(<span class="st">&quot;examples/nonmem/xgxr001.lst&quot;</span>, </span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true"></a>    <span class="dt">package =</span> <span class="st">&quot;NMdata&quot;</span>), <span class="dt">col.row =</span> <span class="st">&quot;ROW&quot;</span>, <span class="dt">quiet =</span> <span class="ot">TRUE</span>, <span class="dt">as.fun =</span> <span class="st">&quot;data.table&quot;</span>)</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true"></a><span class="co">#&gt; In NMscanData(system.file(&quot;examples/nonmem/xgxr001.lst&quot;, package = &quot;NMdata&quot;), :</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true"></a><span class="co">#&gt; Input data columns will be appended to output data. However, column(s) were</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true"></a><span class="co">#&gt; identified as unique identifiers, present in both input and output data. If</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true"></a><span class="co">#&gt; this column or one of these columns is not modified by the Nonmem run,</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true"></a><span class="co">#&gt; consider using this in col.row for a robust merge of input and output data.</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true"></a><span class="co">#&gt; Candidate columns: ROW To skip this check, please specify a value in</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true"></a><span class="co">#&gt; method.combine argument.</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true"></a><span class="co">#&gt; In col.row = &quot;ROW&quot;, quiet = TRUE, as.fun = &quot;data.table&quot;) : Input data columns</span></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true"></a><span class="co">#&gt; will be appended to output data. However, column(s) were identified as unique</span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true"></a><span class="co">#&gt; identifiers, present in both input and output data. If this column or one of</span></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true"></a><span class="co">#&gt; these columns is not modified by the Nonmem run, consider using this in</span></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true"></a><span class="co">#&gt; col.row for a robust merge of input and output data. Candidate columns: ROW To</span></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true"></a><span class="co">#&gt; skip this check, please specify a value in method.combine argument.</span></span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true"></a><span class="co">#&gt; Warning: In NMscanData(system.file(&quot;examples/nonmem/xgxr001.lst&quot;, package = &quot;NMdata&quot;), :</span></span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true"></a><span class="co">#&gt; input control stream</span></span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true"></a><span class="co">#&gt; (C:/Users/delff/working_copies/NMdata/inst/examples/nonmem/xgxr001.mod) is</span></span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true"></a><span class="co">#&gt; newer than output control stream</span></span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true"></a><span class="co">#&gt; (C:/Users/delff/working_copies/NMdata/inst/examples/nonmem/xgxr001.lst) Seems</span></span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true"></a><span class="co">#&gt; like model has been edited since last run. If data sections have been edited,</span></span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true"></a><span class="co">#&gt; this can corrupt results.</span></span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true"></a><span class="co">#&gt; In col.row = &quot;ROW&quot;, quiet = TRUE, as.fun = &quot;data.table&quot;) : input control</span></span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true"></a><span class="co">#&gt; stream (C:/Users/delff/working_copies/NMdata/inst/examples/nonmem/xgxr001.mod)</span></span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true"></a><span class="co">#&gt; is newer than output control stream</span></span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true"></a><span class="co">#&gt; (C:/Users/delff/working_copies/NMdata/inst/examples/nonmem/xgxr001.lst) Seems</span></span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true"></a><span class="co">#&gt; like model has been edited since last run. If data sections have been edited,</span></span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true"></a><span class="co">#&gt; this can corrupt results.</span></span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true"></a>res1<span class="op">$</span>trtact &lt;-<span class="st"> </span><span class="kw">reorder</span>(res1<span class="op">$</span>trtact, res1<span class="op">$</span>DOSE)</span>
<span id="cb12-30"><a href="#cb12-30" aria-hidden="true"></a><span class="co">## with data.table, create a new column representing ID-level</span></span>
<span id="cb12-31"><a href="#cb12-31" aria-hidden="true"></a><span class="co">## Cmax</span></span>
<span id="cb12-32"><a href="#cb12-32" aria-hidden="true"></a>res1[, <span class="st">`</span><span class="dt">:=</span><span class="st">`</span>(Cmax, <span class="kw">max</span>(IPRED)), by =<span class="st"> </span>.(ID)]</span>
<span id="cb12-33"><a href="#cb12-33" aria-hidden="true"></a><span class="co">## findCovs picks the columns that do not vary within cols.id.</span></span>
<span id="cb12-34"><a href="#cb12-34" aria-hidden="true"></a><span class="co">## One row per value of cols.id.</span></span>
<span id="cb12-35"><a href="#cb12-35" aria-hidden="true"></a>res1.id &lt;-<span class="st"> </span><span class="kw">findCovs</span>(res1, <span class="dt">cols.id =</span> <span class="st">&quot;ID&quot;</span>)</span>
<span id="cb12-36"><a href="#cb12-36" aria-hidden="true"></a><span class="kw">dim</span>(res1.id)</span>
<span id="cb12-37"><a href="#cb12-37" aria-hidden="true"></a><span class="co">#&gt; [1] 131  34</span></span>
<span id="cb12-38"><a href="#cb12-38" aria-hidden="true"></a><span class="kw">ggplot</span>(res1.id, <span class="kw">aes</span>(WEIGHTB, Cmax<span class="op">/</span>DOSE, <span class="dt">colour =</span> trtact)) <span class="op">+</span><span class="st"> </span><span class="kw">geom_point</span>() <span class="op">+</span><span class="st"> </span></span>
<span id="cb12-39"><a href="#cb12-39" aria-hidden="true"></a><span class="st">    </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">&quot;Bodyweight at baseline (kg)&quot;</span>)</span></code></pre></div>
<p><img src="data:image/png;base64,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" /><!-- --></p>
<p><code>cols.id</code> can be longer than one. Include a study column, a treatment column to support cross-over, or a model column if you are comparing model fits (see below how to do this very easily).</p>
<p>If your model includes occasion variability, you probably also want to look at</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true"></a><span class="co">## we have no occasion variability in this data res1.id.occ &lt;-</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true"></a><span class="co">## findCovs(res1,cols.id=c(&#39;ID&#39;,&#39;OCC&#39;))</span></span></code></pre></div>
<p>The simplest use of <code>findCovs</code> is to get variables that are constant across the whole dataset:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true"></a><span class="kw">findCovs</span>(res1)</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true"></a><span class="co">#&gt;    EVID CMT AMT FLAG STUDY TVKA TVV2 TVCL TVV3  TVQ  KA  V2  CL   V3    Q IPRED</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true"></a><span class="co">#&gt; 1:    0   2   0    0     1  0.9  4.2  3.6 5.81 3.44 0.9 4.2 3.6 5.81 3.44     0</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true"></a><span class="co">#&gt;    PRED BLQ CYCLE PART PROFDAY nmout EVENTU             NAME TIMEUNIT</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true"></a><span class="co">#&gt; 1:    0   0     1    1       1  TRUE  ng/mL PK Concentration    Hours</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true"></a><span class="co">#&gt;            flag   model Cmax</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true"></a><span class="co">#&gt; 1: Analysis set xgxr001    0</span></span></code></pre></div>
<p>Let’s take a look at what is in the <code>res1.id</code> generated above. It is a mix of variables that vary at subject level and variables that are constant across the full dataset.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true"></a><span class="kw">dim</span>(res1.id)</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true"></a><span class="co">#&gt; [1] 131  34</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true"></a><span class="kw">head</span>(res1.id, <span class="dv">2</span>)</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true"></a><span class="co">#&gt;    ID EVID CMT AMT FLAG STUDY TVKA TVV2 TVCL TVV3  TVQ  KA  V2  CL   V3    Q</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true"></a><span class="co">#&gt; 1: 35    0   2   0    0     1  0.9  4.2  3.6 5.81 3.44 0.9 4.2 3.6 5.81 3.44</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true"></a><span class="co">#&gt; 2: 40    0   2   0    0     1  0.9  4.2  3.6 5.81 3.44 0.9 4.2 3.6 5.81 3.44</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true"></a><span class="co">#&gt;    IPRED PRED BLQ CYCLE DOSE PART PROFDAY WEIGHTB   EFF0 nmout EVENTU</span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true"></a><span class="co">#&gt; 1:     0    0   0     1    3    1       1  80.384 58.419  TRUE  ng/mL</span></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true"></a><span class="co">#&gt; 2:     0    0   0     1    3    1       1 134.090 49.498  TRUE  ng/mL</span></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true"></a><span class="co">#&gt;                NAME TIMEUNIT TRTACT         flag trtact   model Cmax</span></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true"></a><span class="co">#&gt; 1: PK Concentration    Hours   3 mg Analysis set   3 mg xgxr001    0</span></span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true"></a><span class="co">#&gt; 2: PK Concentration    Hours   3 mg Analysis set   3 mg xgxr001    0</span></span></code></pre></div>
<p><code>findCovs</code> has a counterpart in <code>findVars</code> which finds variables that do vary within constant values of optional <code>cols.id</code> columns. To get only the ones that vary within the dataset (i.e. they are truely subject-level variables and not say a study number if we only have one study), we can do</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true"></a>res1.id2 &lt;-<span class="st"> </span><span class="kw">findVars</span>(res1.id)</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true"></a><span class="kw">dim</span>(res1.id2)</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true"></a><span class="co">#&gt; [1] 131   6</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true"></a><span class="kw">head</span>(res1.id2, <span class="dv">2</span>)</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true"></a><span class="co">#&gt;    ID DOSE WEIGHTB   EFF0 TRTACT trtact</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true"></a><span class="co">#&gt; 1: 35    3  80.384 58.419   3 mg   3 mg</span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true"></a><span class="co">#&gt; 2: 40    3 134.090 49.498   3 mg   3 mg</span></span></code></pre></div>
<p><code>findVars</code> supports the cols.id argument too. So you can use <code>findVars(res1,cols.id=&quot;ID&quot;)</code> to find variables that are non-constant within (at least one value of) ID. <code>cols.id</code> can be of arbitrary length.</p>
<p>Of course, we most often know what covariates or other subject-level variables to look at, and we would not search for them after running a nonmem model. But in the situation where you are looking at someone else’s work or you are doing a meta analysis across models where the data has been coded slightly differently, these simple tools can be very useful. Or if you like writing generic wrapper functions, you may find this very handy. Also, remember that if a variable is returned by these functions, you know that they fullfill the variability requirement. We know that variables in <code>res1.id</code> above do not vary within <code>ID</code>, meaning that no <code>ID</code> has more than one value of the variable. <code>NA</code> counts as any other value, so if a value is returned for subject in <code>res1.id</code>, this subject does not have <code>NA</code>’s in <code>res1</code>.</p>
</div>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
